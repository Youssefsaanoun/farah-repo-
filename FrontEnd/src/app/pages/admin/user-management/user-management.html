<div class="dashboard-container fade-in">

  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="gradient-text">Administration</span>
      </h1>
      <p class="page-subtitle">
        Administration de l'expérience client & management de la communauté.
      </p>
    </div>

    <div class="header-actions">
      <button class="btn-primary" (click)="openAddModal()">
        <i class="fas fa-plus"></i> Ajouter Utilisateur
      </button>
      <button class="btn-export" (click)="exportToExcel()">
        <i class="fas fa-file-export"></i> Exporter
      </button>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <!-- Total Users -->
    <div class="stat-card">
      <div class="stat-content">
        <div>
          <p class="stat-label">Total Membres</p>
          <p class="stat-value">{{ totalUsers }}</p>
        </div>
        <div class="stat-icon icon-amber">
          <i class="fas fa-users"></i>
        </div>
      </div>
      <div class="stat-footer">
        <span class="trend positive">
          <i class="fas fa-arrow-up"></i> 12%
        </span>
        <span class="trend-label">cette semaine</span>
      </div>
    </div>

    <!-- Active Users -->
    <div class="stat-card">
      <div class="stat-content">
        <div>
          <p class="stat-label">Actifs</p>
          <p class="stat-value">{{ activeUsers }}</p>
        </div>
        <div class="stat-icon icon-green">
          <i class="fas fa-user-check"></i>
        </div>
      </div>
      <div class="stat-footer">
        <span class="trend-text green">Opérationnels</span>
      </div>
    </div>

    <!-- Blocked Users -->
    <div class="stat-card">
      <div class="stat-content">
        <div>
          <p class="stat-label">Restreints</p>
          <p class="stat-value">{{ blockedUsers }}</p>
        </div>
        <div class="stat-icon icon-red">
          <i class="fas fa-lock"></i>
        </div>
      </div>
      <div class="stat-footer">
        <span class="trend-badge red">Attention requise</span>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="content-card">

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" [(ngModel)]="searchTerm" (input)="filterUsers()" class="search-input"
          placeholder="Rechercher par nom, email..." autocomplete="off" name="search">
      </div>

      <div class="filters">
        <span class="filter-label">Trier par:</span>
        <select class="filter-select" [(ngModel)]="sortOption" (change)="sortUsers()">
          <option>Date d'inscription</option>
          <option>Nom (A-Z)</option>
          <option>Role</option>
        </select>
      </div>
    </div>

    <!-- Enhanced Table -->
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Utilisateur</th>
            <th>Rôle</th>
            <th>Statut</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredUsers; let i = index" class="user-row animate-slide-up"
            [style.animation-delay]="i * 50 + 'ms'">

            <!-- User Profile -->
            <td>
              <div class="user-profile">
                <div class="avatar">
                  {{ user.firstName.charAt(0).toUpperCase() }}{{ user.lastName.charAt(0).toUpperCase() }}
                </div>
                <div class="user-info">
                  <div class="user-name">{{ user.firstName }} {{ user.lastName }}</div>
                  <div class="user-email">{{ user.email }}</div>
                </div>
              </div>
            </td>

            <!-- Role Badge -->
            <td>
              <span class="badge" [class.badge-admin]="user.role === 'ADMIN'"
                [class.badge-client]="user.role !== 'ADMIN'">
                <i *ngIf="user.role === 'ADMIN'" class="fas fa-shield-alt"></i>
                {{ user.role }}
              </span>
            </td>

            <!-- Status -->
            <td>
              <div class="status-indicator" [class.status-blocked]="user.isBlocked"
                [class.status-active]="!user.isBlocked">
                <span class="dot"></span>
                <span class="status-text">{{ user.isBlocked ? 'Bloqué' : 'Actif' }}</span>
              </div>
            </td>

            <!-- Actions -->
            <td class="text-right">
              <div class="actions-group">
                <!-- Actions for all users including self -->
                <button (click)="openEditModal(user)" class="btn-icon btn-edit" title="Modifier">
                  <i class="fas fa-edit"></i>
                </button>

                <!-- Actions for OTHER users only -->
                <ng-container *ngIf="user.id !== currentUser?.id">
                  <button *ngIf="!user.isBlocked" (click)="blockUser(user.id)" class="btn-icon btn-block"
                    title="Bloquer">
                    <i class="fas fa-lock"></i>
                  </button>

                  <button *ngIf="user.isBlocked" (click)="unblockUser(user.id)" class="btn-icon btn-unblock"
                    title="Débloquer">
                    <i class="fas fa-unlock"></i>
                  </button>

                  <span class="divider"></span>

                  <button (click)="deleteUser(user.id)" class="btn-icon btn-delete" title="Supprimer">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </ng-container>

                <!-- Current User Indicator -->
                <span *ngIf="user.id === currentUser?.id" class="text-xs text-gray-400 italic">
                  (Vous)
                </span>

              </div>
            </td>
          </tr>

          <!-- No Results -->
          <tr *ngIf="filteredUsers.length === 0">
            <td colspan="4" class="no-results">
              <div class="no-results-content">
                <div class="icon-circle">
                  <i class="fas fa-search"></i>
                </div>
                <h3>Aucun utilisateur trouvé</h3>
                <p>Essayez de modifier vos termes de recherche.</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="dashboard-footer">
      <span class="footer-text">Farah Couture Admin Panel &copy; 2026</span>
      <div class="pagination-dots">
        <span class="dot active"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </div>
    </div>
  </div>
</div>

<!-- Modal Overlay -->
<div class="modal-overlay" *ngIf="showModal" [class.active]="showModal">
  <div class="modal-container">
    <div class="modal-header">
      <h2>{{ modalMode === 'add' ? 'Ajouter un utilisateur' : 'Modifier l\'utilisateur' }}</h2>
      <button class="btn-close" (click)="closeModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <form autocomplete="off">
        <!-- Hack to disable chrome autofill -->
        <input style="display:none">
        <input type="password" style="display:none">

        <div class="form-group">
          <label>Nom</label>
          <input type="text" [(ngModel)]="selectedUser.lastName" name="lastName" placeholder="Nom de famille"
            autocomplete="off">
        </div>
        <div class="form-group">
          <label>Prénom</label>
          <input type="text" [(ngModel)]="selectedUser.firstName" name="firstName" placeholder="Prénom"
            autocomplete="off">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" [(ngModel)]="selectedUser.email" name="email" placeholder="Adresse email"
            autocomplete="off">
        </div>
        <div class="form-group" *ngIf="modalMode === 'add' || modalMode === 'edit'">
          <label>Mot de passe {{ modalMode === 'edit' ? '(laisser vide pour ne pas changer)' : '' }}</label>
          <input type="password" [(ngModel)]="selectedUser.password" name="password" placeholder="Mot de passe"
            autocomplete="new-password">
        </div>
        <div class="form-group">
          <label>Rôle</label>
          <select [(ngModel)]="selectedUser.role" name="role">
            <option value="CLIENT">Client</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeModal()">Annuler</button>
      <button class="btn-save" (click)="submitUser()">Enregistrer</button>
    </div>
  </div>
</div>